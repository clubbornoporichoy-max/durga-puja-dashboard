<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Durga Puja Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9;}
    header {background:#6a1b9a; color:white; padding:20px; text-align:center;}
    h1 {margin:0;}
    .container {padding:20px;}
    .grid {display:grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap:20px;}
    .card {background:white; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    .card h2 {margin-top:0;}
    .list {max-height:200px; overflow-y:auto;}
    .list div {padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;}
    .form-group {margin-bottom:10px;}
    label {display:block; margin-bottom:5px;}
    input {width:100%; padding:8px; box-sizing:border-box;}
    button {background:#6a1b9a; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer;}
    button:hover {background:#4a148c;}
    canvas {max-width:100%; height:300px;}
    .summary {display:flex; justify-content:space-between; margin:20px 0;}
    .summary div {background:#e1bee7; padding:15px; border-radius:8px; flex:1; margin:5px; text-align:center;}
    .edit-btn, .delete-btn {background:none; border:none; cursor:pointer; margin-left:10px;}
    .edit-btn {color:blue;}
    .delete-btn {color:red;}
  </style>
</head>
<body>
  <header>
    <h1>Durga Puja Dashboard</h1>
  </header>
  <div class="container">
    <div class="summary">
      <div>
        <h3>Total Income</h3>
        <p id="total-income">0</p>
      </div>
      <div>
        <h3>Total Expenses</h3>
        <p id="total-expense">0</p>
      </div>
      <div>
        <h3>Balance</h3>
        <p id="balance">0</p>
      </div>
      <div>
        <h3>Top Contributor</h3>
        <p id="top-contributor">-</p>
      </div>
    </div>

    <div class="grid">
      <!-- Members -->
      <div class="card">
        <h2>Members Contribution</h2>
        <div class="form-group"><label>Name</label><input type="text" id="member-name"></div>
        <div class="form-group"><label>Amount</label><input type="number" id="member-amount"></div>
        <button onclick="addMember()">Add Member</button>
        <div class="list" id="members-list"></div>
        <canvas id="members-chart"></canvas>
      </div>

      <!-- Other Income -->
      <div class="card">
        <h2>Other Income</h2>
        <div class="form-group"><label>Source</label><input type="text" id="income-source"></div>
        <div class="form-group"><label>Amount</label><input type="number" id="income-amount"></div>
        <button onclick="addIncome()">Add Income</button>
        <div class="list" id="income-list"></div>
        <canvas id="income-chart"></canvas>
      </div>

      <!-- Expenses -->
      <div class="card">
        <h2>Expenses</h2>
        <div class="form-group"><label>Description</label><input type="text" id="expense-desc"></div>
        <div class="form-group"><label>Cost</label><input type="number" id="expense-cost"></div>
        <button onclick="addExpense()">Add Expense</button>
        <div class="list" id="expense-list"></div>
        <canvas id="expense-chart"></canvas>
      </div>
    </div>

    <!-- Trend -->
    <div class="card" style="margin-top:20px;">
      <h2>Income vs Expense Trend</h2>
      <canvas id="trend-chart"></canvas>
    </div>
  </div>

  <script>
    // Firebase Config (keep your own)
    const firebaseConfig = {
      apiKey: "AIzaSyCuVs6jx7HiNIx25lzLgoq1B6nQqaHLHm0",
      authDomain: "guestandcollection.firebaseapp.com",
      projectId: "guestandcollection",
      storageBucket: "guestandcollection.appspot.com",
      messagingSenderId: "272278233160",
      appId: "1:272278233160:web"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const membersList=document.getElementById('members-list');
    const incomeList=document.getElementById('income-list');
    const expenseList=document.getElementById('expense-list');
    const totalIncomeEl=document.getElementById('total-income');
    const totalExpenseEl=document.getElementById('total-expense');
    const balanceEl=document.getElementById('balance');
    const topContributorEl=document.getElementById('top-contributor');

    let membersChart,incomeChart,expenseChart,trendChart;

    // âœ… Added running totals
    let membersTotal = 0;
    let otherIncomeTotal = 0;

    function updateTotalIncome() {
      const total = membersTotal + otherIncomeTotal;
      totalIncomeEl.textContent = total;
      balanceEl.textContent = total - parseInt(totalExpenseEl.textContent || 0);
    }

    function randomColor(i){const colors=['#FF6F61','#6B5B95','#88B04B','#F7CAC9','#92A8D1','#955251','#B565A7']; return colors[i%colors.length];}

    function formatEntry(doc,type){
      const d=doc.data();
      const div=document.createElement('div');
      let text='';
      if(type==='member') text=`${d.name}: â‚¹${d.amount}`;
      if(type==='income') text=`${d.source}: â‚¹${d.amount}`;
      if(type==='expense') text=`${d.desc}: â‚¹${d.cost}`;
      div.textContent=text;

      const edit=document.createElement('button');
      edit.textContent='âœŽ';
      edit.className='edit-btn';
      edit.onclick=()=>editEntry(doc,type);
      div.appendChild(edit);

      const del=document.createElement('button');
      del.textContent='ðŸ—‘';
      del.className='delete-btn';
      del.onclick=()=>deleteEntry(doc.id,type);
      div.appendChild(del);

      return div;
    }

    function addMember(){
      const name=document.getElementById('member-name').value;
      const amount=parseInt(document.getElementById('member-amount').value);
      if(name && amount){
        db.collection('members').add({name,amount,createdAt:new Date()});
        document.getElementById('member-name').value='';
        document.getElementById('member-amount').value='';
      }
    }

    function addIncome(){
      const source=document.getElementById('income-source').value;
      const amount=parseInt(document.getElementById('income-amount').value);
      if(source && amount){
        db.collection('otherIncome').add({source,amount,createdAt:new Date()});
        document.getElementById('income-source').value='';
        document.getElementById('income-amount').value='';
      }
    }

    function addExpense(){
      const desc=document.getElementById('expense-desc').value;
      const cost=parseInt(document.getElementById('expense-cost').value);
      if(desc && cost){
        db.collection('expenses').add({desc,cost,createdAt:new Date()});
        document.getElementById('expense-desc').value='';
        document.getElementById('expense-cost').value='';
      }
    }

    function editEntry(doc,type){
      const d=doc.data();
      if(type==='member'){
        const newAmount=parseInt(prompt('Edit amount',d.amount));
        if(newAmount) db.collection('members').doc(doc.id).update({amount:newAmount});
      }
      if(type==='income'){
        const newAmount=parseInt(prompt('Edit amount',d.amount));
        if(newAmount) db.collection('otherIncome').doc(doc.id).update({amount:newAmount});
      }
      if(type==='expense'){
        const newCost=parseInt(prompt('Edit cost',d.cost));
        if(newCost) db.collection('expenses').doc(doc.id).update({cost:newCost});
      }
    }

    function deleteEntry(id,type){
      if(confirm('Delete this entry?')){
        if(type==='member') db.collection('members').doc(id).delete();
        if(type==='income') db.collection('otherIncome').doc(id).delete();
        if(type==='expense') db.collection('expenses').doc(id).delete();
      }
    }

    // âœ… Members snapshot
    db.collection('members').orderBy('createdAt').onSnapshot(snapshot=>{
      membersList.innerHTML='';
      membersTotal=0;
      let top=0,topName='-';
      let labels=[],data=[];
      snapshot.forEach(doc=>{
        const d=doc.data();
        membersTotal+=d.amount;
        labels.push(d.name);
        data.push(d.amount);
        if(d.amount>top){top=d.amount;topName=d.name;}
        membersList.appendChild(formatEntry(doc,'member'));
      });
      topContributorEl.textContent=topName;
      if(membersChart) membersChart.destroy();
      const ctx=document.getElementById('members-chart').getContext('2d');
      membersChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Amount',data,backgroundColor:labels.map((_,i)=>randomColor(i))}]},options:{responsive:true}});
      updateTotalIncome();
      updateTrendChart();
    });

    // âœ… Other income snapshot
    db.collection('otherIncome').orderBy('createdAt').onSnapshot(snapshot=>{
      incomeList.innerHTML='';
      otherIncomeTotal=0;
      let labels=[],data=[];
      snapshot.forEach(doc=>{
        const d=doc.data();
        otherIncomeTotal+=d.amount;
        labels.push(d.source);
        data.push(d.amount);
        incomeList.appendChild(formatEntry(doc,'income'));
      });
      if(incomeChart) incomeChart.destroy();
      const ctx=document.getElementById('income-chart').getContext('2d');
      incomeChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Amount',data,backgroundColor:labels.map((_,i)=>randomColor(i))}]},options:{responsive:true}});
      updateTotalIncome();
      updateTrendChart();
    });

    // Expenses snapshot
    db.collection('expenses').orderBy('createdAt').onSnapshot(snapshot=>{
      expenseList.innerHTML='';
      let total=0;
      let labels=[],data=[];
      snapshot.forEach(doc=>{
        const d=doc.data();
        total+=d.cost;
        labels.push(d.desc);
        data.push(d.cost);
        expenseList.appendChild(formatEntry(doc,'expense'));
      });
      totalExpenseEl.textContent=total;
      balanceEl.textContent=(parseInt(totalIncomeEl.textContent||0))-total;
      if(expenseChart) expenseChart.destroy();
      const ctx=document.getElementById('expense-chart').getContext('2d');
      expenseChart=new Chart(ctx,{type:'pie',data:{labels,datasets:[{data,backgroundColor:labels.map((_,i)=>randomColor(i))}]},options:{responsive:true}});
      updateTrendChart();
    });

    // âœ… Updated Trend Chart
    function updateTrendChart(){
      db.collection('members').get().then(memSnap=>{
        db.collection('otherIncome').get().then(incSnap=>{
          db.collection('expenses').get().then(expSnap=>{
            let dates={};

            // Members
            memSnap.forEach(doc=>{
              const d=doc.data();
              const date=d.createdAt?d.createdAt.toDate().toLocaleDateString():'Unknown';
              dates[date]=(dates[date]||{income:0,expense:0});
              dates[date].income+=d.amount;
            });

            // Other Income
            incSnap.forEach(doc=>{
              const d=doc.data();
              const date=d.createdAt?d.createdAt.toDate().toLocaleDateString():'Unknown';
              dates[date]=(dates[date]||{income:0,expense:0});
              dates[date].income+=d.amount;
            });

            // Expenses
            expSnap.forEach(doc=>{
              const d=doc.data();
              const date=d.createdAt?d.createdAt.toDate().toLocaleDateString():'Unknown';
              dates[date]=(dates[date]||{income:0,expense:0});
              dates[date].expense+=d.cost;
            });

            // âœ… Keep balance in sync with summary
            const totalIncome = membersTotal + otherIncomeTotal;
            const totalExpense = parseInt(totalExpenseEl.textContent || 0);
            balanceEl.textContent = totalIncome - totalExpense;

            const sortedDates=Object.keys(dates).sort((a,b)=>new Date(a)-new Date(b));
            const labels=sortedDates;
            const incomes=sortedDates.map(date=>dates[date].income);
            const expenses=sortedDates.map(date=>dates[date].expense);

            if(trendChart) trendChart.destroy();
            const ctx=document.getElementById('trend-chart').getContext('2d');
            trendChart=new Chart(ctx,{
              type:'line',
              data:{labels,datasets:[
                {label:'Income',data:incomes,fill:false,borderColor:'#06D6A0'},
                {label:'Expense',data:expenses,fill:false,borderColor:'#FF6F61'}
              ]},
              options:{responsive:true}
            });
          });
        });
      });
    }
  </script>
</body>
</html>
