<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Durga Puja Dashboard</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: 'Poppins', sans-serif; margin: 0; background: #F7F7F7; }
header { background: linear-gradient(90deg, #FF6F61, #FFD166); padding: 20px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative;}
header h1 { margin: 0; font-size: 2rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
#export-import { position: absolute; top: 20px; right: 20px; display:flex; gap:10px; }
.container { max-width: 1200px; margin: auto; padding: 20px; }
section.card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); transition: transform 0.2s; }
section.card:hover { transform: translateY(-5px); }
h2 { color: #333; margin-bottom: 10px; }
ul { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; margin-bottom: 10px; }
li { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px solid #eee; align-items: center; flex-wrap:wrap; gap:5px; }
input, select, textarea { padding: 6px 8px; margin-right: 5px; border-radius: 6px; border: 1px solid #ccc; width:100%; }
button { padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer; transition: 0.2s; }
.add-btn { background: #06D6A0; color: white; }
.edit-btn { background: orange; color: white; }
.delete-btn { background: red; color: white; }
.export-btn { background:#4D96FF; color:white;}
.import-btn { background:#FF6FFF; color:white;}
button:hover { opacity: 0.85; transform: scale(1.05); }
.chart-container { width: 100%; height: 300px; margin-top: 20px; }
.hidden { display: none; }
.flex-row { display: flex; gap: 20px; flex-wrap: wrap; }
.flex-row > section { flex: 1 1 calc(50% - 20px); }
.summary-mini { display:flex; justify-content: space-between; padding:10px; border-radius:8px; background:#FFEBCD; margin-bottom:10px; font-weight:600;}
.details-field { width:100%; padding:5px; border-radius:5px; margin-top:3px; border:1px solid #ccc; }
</style>
</head>
<body>

<header>
  <h1> Durga Puja CLUB BORNOPORICHOY Dashboard 2025 </h1>
  <div id="export-import">
    <button class="export-btn" id="export-csv">Export CSV</button>
    <button class="import-btn" id="import-csv">Import CSV</button>
  </div>
</header>

<div class="container">

  <div id="login-section">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="login-btn">Login</button>
    <p id="login-error" style="color:red;"></p>
  </div>

  <div id="dashboard" class="hidden">

    <div class="flex-row">
      <section class="card">
        <h2>Summary</h2>
        <div class="summary-mini">Total Income: ‚Çπ<span id="total-income">0</span></div>
        <div class="summary-mini">Total Expenses: ‚Çπ<span id="total-expense">0</span></div>
        <div class="summary-mini">Balance: ‚Çπ<span id="balance">0</span></div>
        <div class="summary-mini">Top Contributor: <span id="top-contributor">-</span></div>
        <div class="summary-mini">Largest Donation: <span id="top-donation">-</span></div>
        <div class="summary-mini">Highest Expense: <span id="top-expense">-</span></div>
      </section>

      <section class="card">
        <h2>Income vs Expense Trend</h2>
        <canvas id="trend-chart"></canvas>
      </section>
    </div>

    <div class="flex-row">
      <section class="card">
        <h2>Members Contribution</h2>
        <ul id="members-list"></ul>
        <div id="members-form">
          <input type="text" id="member-name" placeholder="Name">
          <input type="number" id="member-amount" placeholder="Amount">
          <textarea id="member-details" placeholder="Details" class="details-field"></textarea>
          <select id="member-recurring">
            <option value="none">No Recurrence</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
          <button class="add-btn" id="add-member">‚ûï Add</button>
        </div>
        <div class="chart-container">
          <canvas id="members-chart"></canvas>
        </div>
      </section>

      <section class="card">
        <h2>Other Income</h2>
        <ul id="income-list"></ul>
        <div id="income-form">
          <input type="text" id="income-source" placeholder="Source">
          <input type="number" id="income-amount" placeholder="Amount">
          <textarea id="income-details" placeholder="Details" class="details-field"></textarea>
          <select id="income-category">
            <option value="General">General</option>
            <option value="Advertisement">Advertisement</option>
            <option value="Donation">Donation</option>
            <option value="Sponsorship">Sponsorship</option>
          </select>
          <select id="income-recurring">
            <option value="none">No Recurrence</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
          <button class="add-btn" id="add-income">‚ûï Add</button>
        </div>
        <div class="chart-container">
          <canvas id="income-chart"></canvas>
        </div>
      </section>

      <section class="card">
        <h2>Expenses</h2>
        <ul id="expense-list"></ul>
        <div id="expense-form">
          <input type="text" id="expense-item" placeholder="Item">
          <input type="number" id="expense-cost" placeholder="Cost">
          <textarea id="expense-details" placeholder="Details" class="details-field"></textarea>
          <select id="expense-category">
            <option value="General">General</option>
            <option value="Food">Food</option>
            <option value="Decoration">Decoration</option>
            <option value="Transport">Transport</option>
            <option value="Misc">Misc</option>
          </select>
          <select id="expense-recurring">
            <option value="none">No Recurrence</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
          <button class="add-btn" id="add-expense">‚ûï Add</button>
        </div>
        <div class="chart-container">
          <canvas id="expense-chart"></canvas>
        </div>
      </section>
    </div>

  </div>
</div>

<!-- Edit Modal -->
<div id="edit-modal" class="hidden" style="
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center;
">
  <div style="background:white; padding:20px; border-radius:12px; width:90%; max-width:400px;">
    <h3 id="edit-title">Edit Entry</h3>
    <input type="text" id="edit-field1" class="details-field" placeholder="">
    <input type="number" id="edit-field2" class="details-field" placeholder="">
    <textarea id="edit-details" class="details-field" placeholder="Details"></textarea>
    <select id="edit-category" class="details-field"></select>
    <select id="edit-recurring" class="details-field">
      <option value="none">No Recurrence</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
    </select>
    <div style="display:flex; justify-content:space-between; margin-top:10px;">
      <button id="save-edit" class="add-btn">üíæ Save</button>
      <button id="cancel-edit" class="delete-btn">‚ùå Cancel</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDO56RHOZ9rGHFo6a4O2hcYw9JLxVdfBwQ",
  authDomain: "create-3b0f7.firebaseapp.com",
  projectId: "create-3b0f7",
  storageBucket: "create-3b0f7.firebasestorage.app",
  messagingSenderId: "222954978623",
  appId: "1:222954978623:web:fb52decc4380934998278a",
  measurementId: "G-TZZ0KCEB1Z"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const YOUR_UID = "6tm3ARsrMwPsyhV5DOqQG3ZqlHv1";

const loginSection = document.getElementById('login-section');
const dashboard = document.getElementById('dashboard');
const loginBtn = document.getElementById('login-btn');
const loginError = document.getElementById('login-error');

const membersList = document.getElementById('members-list');
const incomeList = document.getElementById('income-list');
const expenseList = document.getElementById('expense-list');

const memberName = document.getElementById('member-name');
const memberAmount = document.getElementById('member-amount');
const memberDetails = document.getElementById('member-details');
const memberRecurring = document.getElementById('member-recurring');
const addMemberBtn = document.getElementById('add-member');

const incomeSource = document.getElementById('income-source');
const incomeAmount = document.getElementById('income-amount');
const incomeDetails = document.getElementById('income-details');
const incomeCategory = document.getElementById('income-category');
const incomeRecurring = document.getElementById('income-recurring');
const addIncomeBtn = document.getElementById('add-income');

const expenseItem = document.getElementById('expense-item');
const expenseCost = document.getElementById('expense-cost');
const expenseDetails = document.getElementById('expense-details');
const expenseCategory = document.getElementById('expense-category');
const expenseRecurring = document.getElementById('expense-recurring');
const addExpenseBtn = document.getElementById('add-expense');

const totalIncomeEl = document.getElementById('total-income');
const totalExpenseEl = document.getElementById('total-expense');
const balanceEl = document.getElementById('balance');
const topContributorEl = document.getElementById('top-contributor');
const topDonationEl = document.getElementById('top-donation');
const topExpenseEl = document.getElementById('top-expense');

let currentUser = null;
let membersChart, incomeChart, expenseChart, trendChart;

// Modal elements
const editModal = document.getElementById('edit-modal');
const editField1 = document.getElementById('edit-field1');
const editField2 = document.getElementById('edit-field2');
const editDetails = document.getElementById('edit-details');
const editCategory = document.getElementById('edit-category');
const editRecurring = document.getElementById('edit-recurring');
const saveEditBtn = document.getElementById('save-edit');
const cancelEditBtn = document.getElementById('cancel-edit');
const editTitle = document.getElementById('edit-title');

let currentEditDoc = null;
let currentEditType = null;

// Login
loginBtn.addEventListener('click', async () => {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    loginSection.classList.add('hidden');
    dashboard.classList.remove('hidden');
    initDashboard();
  } catch(e) {
    loginError.textContent = e.message;
  }
});

// Utility
function randomColor(i){ const colors=["#FF6F61","#FFD166","#06D6A0","#4D96FF","#FF6FFF","#FFA500"]; return colors[i%colors.length]; }
function formatEntry(doc, type){
  const d=doc.data();
  let mainText='';
  if(type==='member') mainText=`${d.name} - ‚Çπ${d.amount}`;
  else if(type==='income') mainText=`${d.source} - ‚Çπ${d.amount}`;
  else mainText=`${d.item} - ‚Çπ${d.cost}`;
  const li=document.createElement('li'); li.textContent=mainText;
  if(currentUser && currentUser.uid===YOUR_UID){
    const edit=document.createElement('button'); edit.textContent='‚úèÔ∏è'; edit.className='edit-btn';
    edit.onclick=()=>openEditModal(doc,type,d);
    const del=document.createElement('button'); del.textContent='üóë'; del.className='delete-btn';
    del.onclick=()=>{db.collection(type==='member'?'members':type==='income'?'otherIncome':'expenses').doc(doc.id).delete()};
    li.appendChild(edit); li.appendChild(del);
  }
  const det=document.createElement('div'); det.style.width='100%'; det.style.fontSize='0.85em'; det.style.color='#555';
  det.textContent=d.details||'-';
  li.appendChild(det);
  return li;
}

// Open modal
function openEditModal(doc, type, data) {
  currentEditDoc = doc;
  currentEditType = type;

  if(type === 'member'){
    editTitle.textContent = "Edit Member";
    editField1.placeholder = "Name"; editField1.value = data.name;
    editField2.placeholder = "Amount"; editField2.value = data.amount;
    editCategory.style.display = 'none';
  } else if(type === 'income'){
    editTitle.textContent = "Edit Income";
    editField1.placeholder = "Source"; editField1.value = data.source;
    editField2.placeholder = "Amount"; editField2.value = data.amount;
    editCategory.style.display = 'block';
    editCategory.innerHTML = `
      <option value="General">General</option>
      <option value="Advertisement">Advertisement</option>
      <option value="Donation">Donation</option>
      <option value="Sponsorship">Sponsorship</option>
    `;
    editCategory.value = data.category || 'General';
  } else {
    editTitle.textContent = "Edit Expense";
    editField1.placeholder = "Item"; editField1.value = data.item;
    editField2.placeholder = "Cost"; editField2.value = data.cost;
    editCategory.style.display = 'block';
    editCategory.innerHTML = `
      <option value="General">General</option>
      <option value="Food">Food</option>
      <option value="Decoration">Decoration</option>
      <option value="Transport">Transport</option>
      <option value="Misc">Misc</option>
    `;
    editCategory.value = data.category || 'General';
  }

  editDetails.value = data.details || '';
  editRecurring.value = data.recurring || 'none';
  editModal.classList.remove('hidden');
}

cancelEditBtn.onclick = () => { editModal.classList.add('hidden'); };

saveEditBtn.onclick = () => {
  const updatedData = {};
  if(currentEditType === 'member'){
    updatedData.name = editField1.value;
    updatedData.amount = parseInt(editField2.value);
  } else if(currentEditType === 'income'){
    updatedData.source = editField1.value;
    updatedData.amount = parseInt(editField2.value);
    updatedData.category = editCategory.value;
  } else {
    updatedData.item = editField1.value;
    updatedData.cost = parseInt(editField2.value);
    updatedData.category = editCategory.value;
  }
  updatedData.details = editDetails.value;
  updatedData.recurring = editRecurring.value;

  const col = currentEditType==='member' ? 'members' :
              currentEditType==='income' ? 'otherIncome' : 'expenses';
  db.collection(col).doc(currentEditDoc.id).update(updatedData);
  editModal.classList.add('hidden');
};

// Automated recurring entries
async function handleRecurring(){
  const collections=['members','otherIncome','expenses'];
  const now=new Date();
  for(const col of collections){
    const snap=await db.collection(col).get();
    snap.forEach(doc=>{
      const d=doc.data();
      if(d.recurring && d.recurring!=='none'){
        const lastDate=d.lastAdded?new Date(d.lastAdded.toDate()):null;
        let shouldAdd=false;
        if(d.recurring==='weekly'){
          if(!lastDate|| (now-lastDate)/(1000*60*60*24)>=7) shouldAdd=true;
        }else if(d.recurring==='monthly'){
          if(!lastDate|| now.getMonth()!==lastDate.getMonth()) shouldAdd=true;
        }
        if(shouldAdd){
          db.collection(col).add({...d,lastAdded:firebase.firestore.Timestamp.fromDate(now)});
          db.collection(col).doc(doc.id).update({lastAdded:firebase.firestore.Timestamp.fromDate(now)});
        }
      }
    });
  }
}

function initDashboard(){
  handleRecurring();
  db.collection('members').onSnapshot(snap=>{
    membersList.innerHTML=''; let total=0; let topName='',topAmt=0;
    snap.forEach(doc=>{
      const d=doc.data(); total+=parseInt(d.amount); if(parseInt(d.amount)>topAmt){topAmt=parseInt(d.amount); topName=d.name;}
      membersList.appendChild(formatEntry(doc,'member'));
    });
    totalIncomeEl.textContent=total;
    topContributorEl.textContent=topName||'-';
    updateCharts();
  });

  db.collection('otherIncome').onSnapshot(snap=>{
    incomeList.innerHTML=''; let total=0; let topAmt=0;
    snap.forEach(doc=>{
      const d=doc.data(); total+=parseInt(d.amount); if(parseInt(d.amount)>topAmt) topAmt=parseInt(d.amount);
      incomeList.appendChild(formatEntry(doc,'income'));
    });
    totalIncomeEl.textContent=parseInt(totalIncomeEl.textContent)+total;
    topDonationEl.textContent=topAmt?`‚Çπ${topAmt}`:'-';
    updateCharts();
  });

  db.collection('expenses').onSnapshot(snap=>{
    expenseList.innerHTML=''; let total=0; let topAmt=0,topItem='';
    snap.forEach(doc=>{
      const d=doc.data(); total+=parseInt(d.cost); if(parseInt(d.cost)>topAmt){topAmt=parseInt(d.cost); topItem=d.item;}
      expenseList.appendChild(formatEntry(doc,'expense'));
    });
    totalExpenseEl.textContent=total;
    balanceEl.textContent=parseInt(totalIncomeEl.textContent)-total;
    topExpenseEl.textContent=topItem||'-';
    updateCharts();
  });
}

// Add
addMemberBtn.addEventListener('click',()=>{db.collection('members').add({name:memberName.value,amount:parseInt(memberAmount.value),details:memberDetails.value,recurring:memberRecurring.value,lastAdded:firebase.firestore.Timestamp.fromDate(new Date())}); memberName.value=''; memberAmount.value=''; memberDetails.value='';});
addIncomeBtn.addEventListener('click',()=>{db.collection('otherIncome').add({source:incomeSource.value,amount:parseInt(incomeAmount.value),details:incomeDetails.value,category:incomeCategory.value,recurring:incomeRecurring.value,lastAdded:firebase.firestore.Timestamp.fromDate(new Date())}); incomeSource.value=''; incomeAmount.value=''; incomeDetails.value='';});
addExpenseBtn.addEventListener('click',()=>{db.collection('expenses').add({item:expenseItem.value,cost:parseInt(expenseCost.value),details:expenseDetails.value,category:expenseCategory.value,recurring:expenseRecurring.value,lastAdded:firebase.firestore.Timestamp.fromDate(new Date())}); expenseItem.value=''; expenseCost.value=''; expenseDetails.value='';});

function updateCharts(){
  if(membersChart) membersChart.destroy();
  if(incomeChart) incomeChart.destroy();
  if(expenseChart) expenseChart.destroy();
  if(trendChart) trendChart.destroy();

  membersChart=new Chart(document.getElementById('members-chart'),{type:'pie',data:{labels:Array.from(membersList.children).map(li=>li.firstChild.textContent.split('-')[0]),datasets:[{data:Array.from(membersList.children).map(li=>parseInt(li.firstChild.textContent.split('‚Çπ')[1])),backgroundColor:Array.from(membersList.children).map((_,i)=>randomColor(i))}]}});

  incomeChart=new Chart(document.getElementById('income-chart'),{type:'bar',data:{labels:Array.from(incomeList.children).map(li=>li.firstChild.textContent.split('-')[0]),datasets:[{label:'Income',data:Array.from(incomeList.children).map(li=>parseInt(li.firstChild.textContent.split('‚Çπ')[1])),backgroundColor:'#06D6A0'}]}});

  expenseChart=new Chart(document.getElementById('expense-chart'),{type:'bar',data:{labels:Array.from(expenseList.children).map(li=>li.firstChild.textContent.split('-')[0]),datasets:[{label:'Expenses',data:Array.from(expenseList.children).map(li=>parseInt(li.firstChild.textContent.split('‚Çπ')[1])),backgroundColor:'#FF6F61'}]}});

  trendChart=new Chart(document.getElementById('trend-chart'),{type:'line',data:{labels:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],datasets:[{label:'Income',data:[5,10,8,12,15,20,25,22,18,10,7,12],borderColor:'#06D6A0',fill:false},{label:'Expense',data:[3,7,6,10,13,18,20,18,15,9,5,10],borderColor:'#FF6F61',fill:false}]}});
}
</script>

</body>
</html>
